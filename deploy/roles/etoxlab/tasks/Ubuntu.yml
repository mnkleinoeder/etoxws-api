---
- name: Install required packages
  apt: name="{{item}}" state=present
  with_items:
  - libyaml-dev

- name: Install Apache2
  apt: name="{{item}}" state=present
  with_items:
  - apache2
  - apache2-utils
  - libapache2-mod-wsgi

- name: Enable apache modules
  apache2_module: state=present name={{item}}
  with_items:
  - env
  - fastcgi
  - proxy
  - proxy_http
  - ssl
  - wsgi
  notify: restart apache

- lineinfile: dest=/etc/apache2/ports.conf regexp='\s*[l|L]isten\s+443' line='Listen 443' state={{abs_or_pres}}
  notify: restart apache

- template: src=conf.d_name_virtual_host.conf.j2 dest={{apache_conf_dir}}/name_virtual_host.conf owner=root group=root mode=0444
  when: APACHE_USE_NAMEVIRTUALHOST
  notify: restart apache

- set_fact: ufw_is_active=false

- name: check if firewall is enabled
  shell: LANG=C ufw status
  changed_when: false
  register: ufw_status

- set_fact: ufw_is_active=true
  when: "'Status: active' in ufw_status.stdout"

- name: open port 443
  ufw: rule=allow name="Apache Secure"
  when: ufw_is_active and APACHE_USE_HTTPS


